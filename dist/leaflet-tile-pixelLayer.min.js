"use strict";!function(){function m(t){return null!=t}function a(t,i){var a=t[0],e=t[1],r=t[2],n=i[0]-a,l=i[1]-e,o=i[2]-r;return function(t,i){return[Math.floor(a+t*n),Math.floor(e+t*l),Math.floor(r+t*o),i]}}function o(t,i,a){return e=t,r=[i,a],(Math.max(r[0],Math.min(e,r[1]))-i)/(a-i);var e,r}L.TilePixelLayer=L.TileLayer.extend({options:{data:null,overlayAlpha:230,gap:2,zIndex:7,gradient:[]},map:null,builder:null,grid:null,gridDataBuilt:null,date:null,replaceNaN:!0,replaceNaNValue:0,"λ0":null,"φ0":null,"Δλ":null,"Δφ":null,ni:null,nj:null,initialize:function(t){L.setOptions(this,t),this.gradient=function(t){for(var r=[],n=[],l=[],i=0;i<t.length-1;i++)r.push(t[i+1][0]),n.push(a(t[i][1],t[i+1][1])),l.push([t[i][0],t[i+1][0]]);return function(t,i){for(var a=0;a<r.length-1&&!(t<=r[a]);a++);var e=l[a];return n[a](o(t,e[0],e[1]),i)}}(t.gradient)},createTile:function(t){var i=L.DomUtil.create("canvas","leafvar-pixel-tile"),a=this.getTileSize();i.width=a.x,i.height=a.y;var e=i.getContext("2d"),r={x:t.x*i.width,y:t.y*i.height,z:t.z,w:i.width,h:i.height};return this.interpolateField(e,r),i},onAdd:function(i){var t,a,c,n=this,l=this;this.map=i,t=this.options,a=t.url,c=t.data,new Promise(function(h){a||h(c);var d=c.min,s=new Image;s.src=a,s.onload=function(){var t=document.createElement("canvas");t.width=s.width,t.height=s.height;var i=t.getContext("2d");i.drawImage(s,0,0);for(var a=i.getImageData(0,0,s.width,s.height),e=[],r=0;r<a.data.length;r+=4){var n=a.data[r].toString(),l=a.data[r+1].toString(),o=a.data[r+2].toString(),u=Number(n+l+o)-Math.abs(d);e.push(u)}h([{header:c,data:e}])}}).then(function(t){n.buildGrid(t),n.map.on("click",function(t){var i=t.latlng,a=i.lat,e=i.lng,r=l.gridDataBuilt.interpolate(e,a);n.options.clickEvt&&n.options.clickEvt(t,r)}),L.TileLayer.prototype.onAdd.call(n,i)})},onRemove:function(t){this.gridDataBuilt=null,L.TileLayer.prototype.onRemove.call(this,t)},createBuilder:function(i){return{header:i.header,data:function(t){return i.data[t]},interpolate:this.bilinearInterpolateScalar}},buildGrid:function(t){var v=this;this.builder=this.createBuilder(t[0]);var i=this.builder.header;this.λ0=i.lo1,this.φ0=i.la1,this.Δλ=i.dx,this.Δφ=i.dy,this.ni=i.nx,this.nj=i.ny,this.date=new Date(i.refTime),this.date.setHours(this.date.getHours()+i.forecastTime),this.grid=[];for(var a=0,e=0;e<this.nj;e++){for(var r=[],n=0;n<this.ni;n++,a++)r[n]=this.builder.data(a),this.replaceNaN&&isNaN(r[n])&&(r[n]=this.replaceNaNValue);r.push(r[0]),this.grid[e]=r}v.gridDataBuilt={date:this.date,interpolate:function(t,i){if(!v.grid)return null;var a,e,r,n=((a=t-v.λ0)-(e=360)*Math.floor(a/e))/v.Δλ,l=(v.φ0-i)/v.Δφ,o=Math.floor(n),u=o+1,h=Math.floor(l),d=h+1;if(r=v.grid[h]){var s=r[o],c=r[u];if(m(s)&&m(c)&&(r=v.grid[d])){var f=r[o],g=r[u];if(m(f)&&m(g))return v.builder.interpolate(n-o,l-h,s,c,f,g)}}return null}}},pointToCoord:function(t,i,a){var e=this.map.unproject(L.point(t,i),a);return[e.lng,e.lat]},createMask:function(t,i){if(!t)return null;var r=i.w,a=i.h,e=new ImageData(r,a),n=e.data;return{imageData:e,set:function(t,i,a){var e=4*(i*r+t);return n[e]=a[0],n[1+e]=a[1],n[2+e]=a[2],n[3+e]=a[3],this}}},bilinearInterpolateScalar:function(t,i,a,e,r,n){var l=1-t,o=1-i;return a*l*o+e*t*o+r*l*i+n*t*i},interpolateField:function(a,c){var f=this,e=c.x,r=0,g=this.map.getZoom()<=4?2:4,v=g,p=this.createMask(a,c);function n(t,i){for(var a=[0,0,0,1],e=c.y,r=0;r<=c.h;e+=v,r+=v){var n=a,l=f.pointToCoord(t,e,c.z);if(l){var o=l[0],u=l[1];if(isFinite(o)){var h=f.gridDataBuilt.interpolate(o,u);m(h)&&(n=f.gradient(h,f.options.overlayAlpha))}}for(var d=0;d<g;d++)for(var s=0;s<v;s++)p.set(i+d,r+s,n)}}!function t(){for(var i=Date.now();r<c.w;)if(n(e,r),e+=g,r+=g,500<Date.now()-i)return void setTimeout(t,25);a.putImageData(p.imageData,0,0)}()}}),L.tilePixelLayer=function(t){return new L.TilePixelLayer(t)}}();